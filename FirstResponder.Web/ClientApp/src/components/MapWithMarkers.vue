<script>
export default {
    props: {
        markers: {
            type: Array,
            default: []
        }
    },
    data() {
        return {
            map: null,
            icons: {
                'incident-icon': `
                    <svg width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                       <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                       <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="#C92A2A"/>
                       <path d="M10.8125 11.9829V22.1562C10.8125 22.38 10.9014 22.5946 11.0596 22.7529C11.2179 22.9111 11.4325 23 11.6562 23C11.88 23 12.0946 22.9111 12.2529 22.7529C12.4111 22.5946 12.5 22.38 12.5 22.1562V16.8125C12.5 16.6633 12.5593 16.5202 12.6648 16.4148C12.7702 16.3093 12.9133 16.25 13.0625 16.25C13.2117 16.25 13.3548 16.3093 13.4602 16.4148C13.5657 16.5202 13.625 16.6633 13.625 16.8125V22.1562C13.625 22.38 13.7139 22.5946 13.8721 22.7529C14.0304 22.9111 14.245 23 14.4688 23C14.6925 23 14.9071 22.9111 15.0654 22.7529C15.2236 22.5946 15.3125 22.38 15.3125 22.1562V12.5938C15.3125 12.5192 15.3421 12.4476 15.3949 12.3949C15.4476 12.3421 15.5192 12.3125 15.5938 12.3125C15.6683 12.3125 15.7399 12.3421 15.7926 12.3949C15.8454 12.4476 15.875 12.5192 15.875 12.5938V15.4062C15.875 15.63 15.9639 15.8446 16.1221 16.0029C16.2804 16.1611 16.495 16.25 16.7188 16.25C16.9425 16.25 17.1571 16.1611 17.3154 16.0029C17.4736 15.8446 17.5625 15.63 17.5625 15.4062V12.3125C17.5625 11.4174 17.2069 10.5589 16.574 9.92601C15.9411 9.29308 15.0826 8.9375 14.1875 8.9375H11.078C10.9034 8.93731 10.7312 8.89649 10.5751 8.81825L10.2039 8.63263C10.049 8.55522 9.91864 8.43627 9.82745 8.28905C9.73626 8.14184 9.68781 7.97217 9.6875 7.799V5.84375C9.6875 5.61997 9.59861 5.40536 9.44037 5.24713C9.28214 5.08889 9.06753 5 8.84375 5C8.61997 5 8.40536 5.08889 8.24713 5.24713C8.08889 5.40536 8 5.61997 8 5.84375V8.18712C8 8.9915 8.4545 9.72837 9.1745 10.0872L10.25 10.625C10.61 10.985 10.8125 11.4732 10.8125 11.9829Z" fill="white"/>
                       <path d="M13.0625 8.375C13.5101 8.375 13.9393 8.19721 14.2557 7.88074C14.5722 7.56428 14.75 7.13505 14.75 6.6875C14.75 6.23995 14.5722 5.81072 14.2557 5.49426C13.9393 5.17779 13.5101 5 13.0625 5C12.6149 5 12.1857 5.17779 11.8693 5.49426C11.5528 5.81072 11.375 6.23995 11.375 6.6875C11.375 7.13505 11.5528 7.56428 11.8693 7.88074C12.1857 8.19721 12.6149 8.375 13.0625 8.375Z" fill="white"/>
                    </svg>`,
            }
        }
    },
    watch: {
        markers() {
            if (!this.map) {
                return;
            }
            
            this.map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    this.map.removeLayer(layer)
                }
            })
            
            this.markers.forEach(marker => {
                L.marker([marker.lat, marker.lon], {
                    icon: L.divIcon({
                        className: '',
                        iconAnchor: [12.5, 40],
                        html: this.getIcon(marker.icon)
                    })
                }).on('click', function() {
                    if (marker.onClickUrl) {
                        window.location = marker.onClickUrl
                    }
                }).addTo(this.map)
            });
        }
    },
    methods: {
        loadLeaflet() {
            const leafletJs = document.createElement('script')
            leafletJs.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
            leafletJs.onload = () => {
                this.map = L.map('map').setView([48.684, 19.677], 8)
                this.map.attributionControl.setPrefix(false)

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map)
                
                this.markers.forEach(marker => {
                    L.marker([marker.lat, marker.lon], {
                        icon: L.divIcon({
                            className: '',
                            iconAnchor: [12.5, 40],
                            html: this.getIcon(marker.icon)
                        })
                    }).on('click', function() {
                        if (marker.onClickUrl) {
                            window.location = marker.onClickUrl
                        }
                    }).addTo(this.map)
                });
                
                if (this.markers.length === 1) {
                    this.map.setView([this.markers[0].lat, this.markers[0].lon], 16)
                }
            }
            document.head.appendChild(leafletJs)
        },
        getIcon(id) {
            if (this.icons[id]) {
                return this.icons[id]
            }
            
            return '';
        }
    },
    mounted() {
        // Generate icons for AED status
        const aedIconColors = [
            'Registered',
            'Ready',
            'NotReady',
            'OutOfService',
            'ServiceRequired',
            'Cancelled'
        ]
        
        for (let i = 0; i < aedIconColors.length; i++) {
            this.icons[`aed-icon-${aedIconColors[i]}`] = `
                <svg class="aed-icon-${aedIconColors[i]}" width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                   <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="currentColor"/>
                   <path fill-rule="evenodd" clip-rule="evenodd" d="M4.24427 12.1847C3.52008 8.66747 5.92469 6.00935 8.62324 5.9847C10.0101 5.96353 11.745 6.69329 12.6696 8.45616C13.5943 6.69329 15.3291 5.96353 16.7161 5.9847C19.4146 6.00935 21.8192 8.66747 21.095 12.1847C20.543 14.8659 17.6742 18.3526 12.6696 21.7323C7.66508 18.3526 4.79632 14.8659 4.24427 12.1847ZM9.74907 16.6282L10.6676 6.95791C11.2992 7.32044 11.8819 7.87383 12.2909 8.65357L12.508 9.06762L11.4718 13.8718L15.3824 11.0546L13.6597 18.8116H14.6734L12.6449 21.0557L11.4354 18.2502L12.4492 18.6045L13.0116 14.2869L9.74907 16.6282Z" fill="white"/>
               </svg>`
        }
        
        // Generated icons for incident status
        const incidentIconColors = [
            'Created',
            'InProgress',
            'Completed',
            'Canceled'
        ]

        for (let i = 0; i < incidentIconColors.length; i++) {
            this.icons[`incident-icon-${incidentIconColors[i]}`] = `
                <svg class="incident-icon-${incidentIconColors[i]}" width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                   <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="currentColor"/>
                   <path d="M10.8125 11.9829V22.1562C10.8125 22.38 10.9014 22.5946 11.0596 22.7529C11.2179 22.9111 11.4325 23 11.6562 23C11.88 23 12.0946 22.9111 12.2529 22.7529C12.4111 22.5946 12.5 22.38 12.5 22.1562V16.8125C12.5 16.6633 12.5593 16.5202 12.6648 16.4148C12.7702 16.3093 12.9133 16.25 13.0625 16.25C13.2117 16.25 13.3548 16.3093 13.4602 16.4148C13.5657 16.5202 13.625 16.6633 13.625 16.8125V22.1562C13.625 22.38 13.7139 22.5946 13.8721 22.7529C14.0304 22.9111 14.245 23 14.4688 23C14.6925 23 14.9071 22.9111 15.0654 22.7529C15.2236 22.5946 15.3125 22.38 15.3125 22.1562V12.5938C15.3125 12.5192 15.3421 12.4476 15.3949 12.3949C15.4476 12.3421 15.5192 12.3125 15.5938 12.3125C15.6683 12.3125 15.7399 12.3421 15.7926 12.3949C15.8454 12.4476 15.875 12.5192 15.875 12.5938V15.4062C15.875 15.63 15.9639 15.8446 16.1221 16.0029C16.2804 16.1611 16.495 16.25 16.7188 16.25C16.9425 16.25 17.1571 16.1611 17.3154 16.0029C17.4736 15.8446 17.5625 15.63 17.5625 15.4062V12.3125C17.5625 11.4174 17.2069 10.5589 16.574 9.92601C15.9411 9.29308 15.0826 8.9375 14.1875 8.9375H11.078C10.9034 8.93731 10.7312 8.89649 10.5751 8.81825L10.2039 8.63263C10.049 8.55522 9.91864 8.43627 9.82745 8.28905C9.73626 8.14184 9.68781 7.97217 9.6875 7.799V5.84375C9.6875 5.61997 9.59861 5.40536 9.44037 5.24713C9.28214 5.08889 9.06753 5 8.84375 5C8.61997 5 8.40536 5.08889 8.24713 5.24713C8.08889 5.40536 8 5.61997 8 5.84375V8.18712C8 8.9915 8.4545 9.72837 9.1745 10.0872L10.25 10.625C10.61 10.985 10.8125 11.4732 10.8125 11.9829Z" fill="white"/>
                   <path d="M13.0625 8.375C13.5101 8.375 13.9393 8.19721 14.2557 7.88074C14.5722 7.56428 14.75 7.13505 14.75 6.6875C14.75 6.23995 14.5722 5.81072 14.2557 5.49426C13.9393 5.17779 13.5101 5 13.0625 5C12.6149 5 12.1857 5.17779 11.8693 5.49426C11.5528 5.81072 11.375 6.23995 11.375 6.6875C11.375 7.13505 11.5528 7.56428 11.8693 7.88074C12.1857 8.19721 12.6149 8.375 13.0625 8.375Z" fill="white"/>
                </svg>`
        }
        
        // Load map and markers using Leaflet
        this.loadLeaflet()
    }
}
</script>

<template>
    <div id="map" style="height: 500px"></div>
</template>

<style scoped>
    @import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
</style>
