<script>
// Used to for bugged this.map in leaflet and vue3
import { toRaw } from "vue";

export default {
    props: {
        markers: {
            type: Array,
            default: []
        }
    },
    data() {
        return {
            map: null,
            icons: {
                'incident-icon': `
                    <svg width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                       <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                       <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="#C92A2A"/>
                       <path d="M10.8125 11.9829V22.1562C10.8125 22.38 10.9014 22.5946 11.0596 22.7529C11.2179 22.9111 11.4325 23 11.6562 23C11.88 23 12.0946 22.9111 12.2529 22.7529C12.4111 22.5946 12.5 22.38 12.5 22.1562V16.8125C12.5 16.6633 12.5593 16.5202 12.6648 16.4148C12.7702 16.3093 12.9133 16.25 13.0625 16.25C13.2117 16.25 13.3548 16.3093 13.4602 16.4148C13.5657 16.5202 13.625 16.6633 13.625 16.8125V22.1562C13.625 22.38 13.7139 22.5946 13.8721 22.7529C14.0304 22.9111 14.245 23 14.4688 23C14.6925 23 14.9071 22.9111 15.0654 22.7529C15.2236 22.5946 15.3125 22.38 15.3125 22.1562V12.5938C15.3125 12.5192 15.3421 12.4476 15.3949 12.3949C15.4476 12.3421 15.5192 12.3125 15.5938 12.3125C15.6683 12.3125 15.7399 12.3421 15.7926 12.3949C15.8454 12.4476 15.875 12.5192 15.875 12.5938V15.4062C15.875 15.63 15.9639 15.8446 16.1221 16.0029C16.2804 16.1611 16.495 16.25 16.7188 16.25C16.9425 16.25 17.1571 16.1611 17.3154 16.0029C17.4736 15.8446 17.5625 15.63 17.5625 15.4062V12.3125C17.5625 11.4174 17.2069 10.5589 16.574 9.92601C15.9411 9.29308 15.0826 8.9375 14.1875 8.9375H11.078C10.9034 8.93731 10.7312 8.89649 10.5751 8.81825L10.2039 8.63263C10.049 8.55522 9.91864 8.43627 9.82745 8.28905C9.73626 8.14184 9.68781 7.97217 9.6875 7.799V5.84375C9.6875 5.61997 9.59861 5.40536 9.44037 5.24713C9.28214 5.08889 9.06753 5 8.84375 5C8.61997 5 8.40536 5.08889 8.24713 5.24713C8.08889 5.40536 8 5.61997 8 5.84375V8.18712C8 8.9915 8.4545 9.72837 9.1745 10.0872L10.25 10.625C10.61 10.985 10.8125 11.4732 10.8125 11.9829Z" fill="white"/>
                       <path d="M13.0625 8.375C13.5101 8.375 13.9393 8.19721 14.2557 7.88074C14.5722 7.56428 14.75 7.13505 14.75 6.6875C14.75 6.23995 14.5722 5.81072 14.2557 5.49426C13.9393 5.17779 13.5101 5 13.0625 5C12.6149 5 12.1857 5.17779 11.8693 5.49426C11.5528 5.81072 11.375 6.23995 11.375 6.6875C11.375 7.13505 11.5528 7.56428 11.8693 7.88074C12.1857 8.19721 12.6149 8.375 13.0625 8.375Z" fill="white"/>
                    </svg>`,
                'responder-walking': `
                    <svg width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                        <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="#009140"/>
                        <path d="M14.4873 5.69201C14.4873 6.14075 14.3091 6.57112 13.9917 6.88843C13.6744 7.20575 13.2441 7.38401 12.7953 7.38401C12.3466 7.38401 11.9162 7.20575 11.5989 6.88843C11.2816 6.57112 11.1033 6.14075 11.1033 5.69201C11.1033 5.24326 11.2816 4.81289 11.5989 4.49558C11.9162 4.17826 12.3466 4 12.7953 4C13.2441 4 13.6744 4.17826 13.9917 4.49558C14.3091 4.81289 14.4873 5.24326 14.4873 5.69201ZM11.0356 8.23227C11.1149 8.143 11.2122 8.07152 11.321 8.02253C11.4299 7.97353 11.5479 7.94814 11.6673 7.94801H13.2973C14.1343 7.94801 14.7862 8.67332 14.6994 9.50466L14.2143 14.1103C14.1981 14.2621 14.1648 14.4115 14.1151 14.5559L13.7564 15.5778L13.9966 15.8508C14.0479 15.9107 14.0912 15.9771 14.1252 16.0482L16.3812 20.8422C16.4319 20.9432 16.4619 21.0532 16.4694 21.1659C16.4768 21.2786 16.4617 21.3916 16.4247 21.4984C16.3878 21.6051 16.3299 21.7034 16.2544 21.7874C16.1789 21.8714 16.0874 21.9394 15.9852 21.9875C15.883 22.0355 15.7722 22.0626 15.6593 22.0672C15.5465 22.0717 15.4338 22.0536 15.3281 22.014C15.2223 21.9743 15.1256 21.9139 15.0436 21.8362C14.9616 21.7586 14.8959 21.6653 14.8505 21.5619L12.6442 16.8762L10.7491 14.7093C10.6033 14.5435 10.528 14.3274 10.5393 14.1069L10.695 11.1594L10.2043 11.711L9.6809 14.8537C9.6441 15.075 9.52087 15.2727 9.33831 15.4033C9.15575 15.5338 8.92882 15.5864 8.70743 15.5496C8.48605 15.5128 8.28835 15.3896 8.15783 15.207C8.02731 15.0245 7.97466 14.7975 8.01146 14.5762L8.57546 11.1922C8.6019 11.0348 8.67229 10.8882 8.7785 10.7692L11.0345 8.23114L11.0356 8.23227Z" fill="white"/>
                        <path d="M10.8208 17.2484V15.6489L12.1789 17.1999L12.4733 17.7909C12.4427 17.8846 12.397 17.9726 12.3379 18.0515L9.51794 21.7175C9.38122 21.8955 9.17939 22.0119 8.95685 22.0411C8.73431 22.0703 8.50928 22.0099 8.33128 21.8732C8.15327 21.7365 8.03687 21.5346 8.00768 21.3121C7.97849 21.0895 8.03889 20.8645 8.17561 20.6865L10.8208 17.2484ZM15.581 12.4938L15.0237 11.9366L15.255 9.85768L15.2617 9.7821L16.5296 11.05H18.1539C18.3783 11.05 18.5935 11.1391 18.7521 11.2978C18.9108 11.4564 18.9999 11.6716 18.9999 11.896C18.9999 12.1204 18.9108 12.3355 18.7521 12.4942C18.5935 12.6529 18.3783 12.742 18.1539 12.742H16.1788C16.0675 12.742 15.9574 12.7201 15.8546 12.6776C15.7518 12.635 15.6584 12.5725 15.5798 12.4938H15.581Z" fill="white"/>
                    </svg>`,
                'responder-bicycle': `<svg width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                        <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="#0000FF"/>
                        <path d="M8.49922 7.55557C8.49922 7.40823 8.55849 7.26691 8.66399 7.16272C8.76948 7.05853 8.91257 7 9.06176 7H10.7494C10.8986 7 11.0417 7.05853 11.1472 7.16272C11.2527 7.26691 11.3119 7.40823 11.3119 7.55557C11.3119 7.70292 11.2527 7.84423 11.1472 7.94842C11.0417 8.05261 10.8986 8.11114 10.7494 8.11114V8.66672H15.4073L15.8415 7.38001C15.8788 7.26943 15.9504 7.17323 16.0461 7.10503C16.1418 7.03683 16.2568 7.00009 16.3748 7H17.4999C17.6491 7 17.7922 7.05853 17.8977 7.16272C18.0032 7.26691 18.0625 7.40823 18.0625 7.55557C18.0625 7.70292 18.0032 7.84423 17.8977 7.94842C17.7922 8.05261 17.6491 8.11114 17.4999 8.11114H16.7799L16.43 9.15006L17.3379 10.5834C18.1203 10.2648 18.9954 10.248 19.7897 10.5365C20.584 10.825 21.2396 11.3976 21.6265 12.141C22.0135 12.8843 22.1036 13.7441 21.8789 14.5499C21.6543 15.3558 21.1313 16.0489 20.4136 16.4918C19.6959 16.9348 18.836 17.0954 18.0041 16.9417C17.1722 16.788 16.4291 16.3313 15.9221 15.662C15.4152 14.9928 15.1812 14.1598 15.2667 13.3283C15.3523 12.4967 15.751 11.7273 16.3838 11.1723L15.8123 10.2701L13.4766 13.9613C13.426 14.0412 13.3557 14.1071 13.2723 14.1528C13.1888 14.1985 13.095 14.2224 12.9996 14.2224H10.7033C10.5866 14.9038 10.2584 15.5325 9.76406 16.0216C9.26975 16.5106 8.63375 16.8359 7.94405 16.9523C7.25436 17.0688 6.54507 16.9707 5.91432 16.6716C5.28356 16.3725 4.76252 15.8871 4.42327 15.2828C4.08402 14.6784 3.94334 13.9848 4.02069 13.2981C4.09804 12.6113 4.3896 11.9652 4.85503 11.4492C5.32046 10.9332 5.93675 10.5729 6.61864 10.418C7.30053 10.2631 8.01431 10.3213 8.66123 10.5846L9.62431 9.06228V8.11114H9.06176C8.91257 8.11114 8.76948 8.05261 8.66399 7.94842C8.55849 7.84423 8.49922 7.70292 8.49922 7.55557ZM10.1869 10.2701L9.61531 11.1746C10.1779 11.6679 10.5716 12.3457 10.7033 13.1113H11.9847L10.1869 10.2701ZM12.9996 12.6191L14.7975 9.77786H11.2017L12.9996 12.6191ZM9.55343 13.1113C9.45758 12.7458 9.26901 12.4104 9.00551 12.1368L8.38896 13.1113H9.55343ZM8.05256 11.5468C7.62335 11.4129 7.16336 11.4093 6.73202 11.5363C6.30069 11.6633 5.91783 11.9151 5.63293 12.2593C5.34803 12.6034 5.17417 13.024 5.13383 13.4668C5.09349 13.9095 5.18852 14.354 5.40663 14.7428C5.62475 15.1317 5.95593 15.447 6.35738 15.648C6.75882 15.849 7.21209 15.9265 7.6586 15.8705C8.10511 15.8145 8.52434 15.6275 8.86212 15.3337C9.19991 15.0399 9.44071 14.6528 9.55343 14.2224H7.37413C7.27372 14.2224 7.17513 14.1959 7.08861 14.1456C7.00209 14.0952 6.93079 14.0229 6.88211 13.9362C6.83343 13.8495 6.80915 13.7514 6.81178 13.6523C6.81442 13.5531 6.84388 13.4565 6.8971 13.3724L8.05256 11.5468ZM16.9936 12.1357C16.6165 12.5279 16.3972 13.0426 16.3768 13.5831C16.3564 14.1236 16.5362 14.6529 16.8827 15.0718C17.2292 15.4907 17.7185 15.7704 18.2588 15.8585C18.7992 15.9466 19.3535 15.8371 19.818 15.5504C20.2824 15.2637 20.625 14.8196 20.7816 14.3013C20.9382 13.783 20.898 13.2261 20.6686 12.7349C20.4392 12.2438 20.0362 11.8522 19.5353 11.6334C19.0344 11.4147 18.47 11.3839 17.9477 11.5468L19.102 13.3724C19.1412 13.4343 19.1676 13.5032 19.1798 13.5751C19.192 13.6471 19.1898 13.7207 19.1731 13.7918C19.1565 13.8629 19.1259 13.93 19.083 13.9894C19.0401 14.0488 18.9858 14.0993 18.9232 14.138C18.8605 14.1767 18.7908 14.2028 18.7179 14.2148C18.645 14.2269 18.5705 14.2246 18.4985 14.2082C18.4265 14.1918 18.3585 14.1616 18.2984 14.1192C18.2382 14.0768 18.1871 14.0232 18.148 13.9613L16.9936 12.1357Z" fill="white"/>
                    </svg>`,
                'responder-car': `<svg width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                        <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="#C92A2A"/>
                        <path d="M6.67643 6.64125C6.88139 6.15375 7.22224 5.73834 7.65666 5.44658C8.09109 5.15481 8.59998 4.99953 9.12018 5H15.8798C16.9423 5 17.9028 5.64567 18.3214 6.64125L19.1629 8.64325C19.2426 8.83283 19.386 8.98883 19.5667 9.08092C20.0979 9.35175 20.4751 9.8555 20.592 10.4481L20.9479 12.267C20.9833 12.4418 21.0007 12.6187 21 12.7978V13.2453C21 14.1271 20.5856 14.9168 19.9375 15.4087V17.4583C19.9375 17.602 19.8815 17.7398 19.7819 17.8414C19.6823 17.9429 19.5471 18 19.4062 18H17.2812C17.1403 18 17.0052 17.9429 16.9056 17.8414C16.806 17.7398 16.75 17.602 16.75 17.4583V16.0088C15.3772 16.0608 13.8334 16.1042 12.5 16.1042C11.1666 16.1042 9.62274 16.0608 8.24999 16.0088V17.4583C8.24999 17.602 8.19402 17.7398 8.0944 17.8414C7.99477 17.9429 7.85964 18 7.71875 18H5.59375C5.45285 18 5.31773 17.9429 5.2181 17.8414C5.11847 17.7398 5.0625 17.602 5.0625 17.4583V15.4087C4.41437 14.9168 4 14.1271 4 13.2453V12.7978C4.00018 12.6196 4.01762 12.4418 4.05206 12.267L4.408 10.447C4.52487 9.8555 4.90206 9.35067 5.43225 9.08092C5.61411 8.98899 5.7577 8.83374 5.83706 8.64325L6.67856 6.64125H6.67643ZM7.18643 13.6667C7.46823 13.6667 7.73848 13.5525 7.93773 13.3494C8.13699 13.1462 8.24893 12.8707 8.24893 12.5833C8.24893 12.296 8.13699 12.0205 7.93773 11.8173C7.73848 11.6141 7.46823 11.5 7.18643 11.5C6.90464 11.5 6.63439 11.6141 6.43513 11.8173C6.23588 12.0205 6.12393 12.296 6.12393 12.5833C6.12393 12.8707 6.23588 13.1462 6.43513 13.3494C6.63439 13.5525 6.90464 13.6667 7.18643 13.6667ZM17.8114 13.6667C18.0932 13.6667 18.3635 13.5525 18.5627 13.3494C18.762 13.1462 18.8739 12.8707 18.8739 12.5833C18.8739 12.296 18.762 12.0205 18.5627 11.8173C18.3635 11.6141 18.0932 11.5 17.8114 11.5C17.5296 11.5 17.2594 11.6141 17.0601 11.8173C16.8609 12.0205 16.7489 12.296 16.7489 12.5833C16.7489 12.8707 16.8609 13.1462 17.0601 13.3494C17.2594 13.5525 17.5296 13.6667 17.8114 13.6667ZM10.3739 11.5C10.0921 11.5 9.82189 11.6141 9.62263 11.8173C9.42337 12.0205 9.31143 12.296 9.31143 12.5833C9.31143 12.8707 9.42337 13.1462 9.62263 13.3494C9.82189 13.5525 10.0921 13.6667 10.3739 13.6667H14.6239C14.9057 13.6667 15.176 13.5525 15.3752 13.3494C15.5745 13.1462 15.6864 12.8707 15.6864 12.5833C15.6864 12.296 15.5745 12.0205 15.3752 11.8173C15.176 11.6141 14.9057 11.5 14.6239 11.5H10.3739ZM7.08656 8.45475C7.04503 8.54213 7.02681 8.63912 7.03375 8.73595C7.04069 8.83279 7.07253 8.92605 7.12607 9.00635C7.17961 9.08664 7.25296 9.15114 7.33873 9.19332C7.4245 9.23551 7.51966 9.25391 7.61462 9.24667C8.58149 9.16758 11.174 9.0625 12.4989 9.0625C13.8239 9.0625 16.4174 9.16758 17.3832 9.24667C17.4782 9.25391 17.5734 9.23551 17.6591 9.19332C17.7449 9.15114 17.8182 9.08664 17.8718 9.00635C17.9253 8.92605 17.9572 8.83279 17.9641 8.73595C17.971 8.63912 17.9528 8.54213 17.9113 8.45475L16.8955 6.38233C16.8514 6.29248 16.7836 6.21692 16.6997 6.16411C16.6158 6.11131 16.5192 6.08334 16.4206 6.08333H8.57724C8.47867 6.08334 8.38204 6.11131 8.29816 6.16411C8.21428 6.21692 8.14647 6.29248 8.10231 6.38233L7.08656 8.45475Z" fill="white"/>
                    </svg>`
            }
        }
    },
    watch: {
        markers() {
            if (!toRaw(this.map)) {
                return
            }
            
            this.refreshMarkers()
        }
    },
    methods: {
        refreshMarkers() {
            if (!toRaw(this.map)) {
                return
            }

            toRaw(this.map).eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    toRaw(this.map).removeLayer(layer)
                }
            })

            this.markers.forEach(marker => {
                let leafletMarker = L.marker([marker.lat, marker.lon], {
                    icon: L.divIcon({
                        className: '',
                        iconAnchor: [12.5, 40],
                        popupAnchor: [0, -40],
                        html: this.getIcon(marker.icon)
                    })
                }).on('click', function() {
                    if (marker.onClickUrl) {
                        window.location = marker.onClickUrl
                    }
                })
                
                if (marker.popup) {
                    leafletMarker.bindPopup(marker.popup)
                }
                
                leafletMarker.addTo(toRaw(this.map))
            })
        },
        loadLeaflet() {
            const leafletJs = document.createElement('script')
            leafletJs.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'
            leafletJs.onload = () => {
                this.map = L.map('map').setView([48.684, 19.677], 8)
                this.map.attributionControl.setPrefix(false)

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(this.map)
                
                this.markers.forEach(marker => {
                    let leafletMarker = L.marker([marker.lat, marker.lon], {
                        icon: L.divIcon({
                            className: '',
                            iconAnchor: [12.5, 40],
                            html: this.getIcon(marker.icon)
                        })
                    }).on('click', function() {
                        if (marker.onClickUrl) {
                            window.location = marker.onClickUrl
                        }
                    })
                    
                    if (marker.popup) {
                        leafletMarker.bindPopup(marker.popup)
                    }

                    leafletMarker.addTo(this.map)
                });
                
                if (this.markers.length === 1) {
                    this.map.setView([this.markers[0].lat, this.markers[0].lon], 16)
                }

                // On map click dispatch js event
                this.map.on('click', (e) => {
                    // use 6 decimal places for lat and lon
                    let lat = e.latlng.lat.toFixed(6)
                    let lon = e.latlng.lng.toFixed(6)
                    
                    window.dispatchEvent(new CustomEvent('on-map-click', { detail: { lat, lon } }))
                })
            }
            document.head.appendChild(leafletJs)
        },
        onLocationChanged(lat, lon, id, icon, initialZoom) {
            if (isNaN(lat) || isNaN(lon)) {
                return
            }

            let marker = this.markers.find(m => m.id === id)

            if (marker) {
                marker.lat = lat
                marker.lon = lon
            } else {
                this.markers.push({
                    lat,
                    lon,
                    id,
                    icon
                })
            }

            this.refreshMarkers()

            if (!marker && initialZoom) {
                toRaw(this.map).setView([lat, lon], 16)
            } else {
                toRaw(this.map).setView([lat, lon])
            }
        },
        getIcon(id) {
            if (this.icons[id]) {
                return this.icons[id]
            }
            
            return '';
        },
        initializeIcons() {
            // Generate icons for AED status
            const aedIconColors = [
                'Registered',
                'Ready',
                'NotReady',
                'OutOfService',
                'ServiceRequired',
                'Cancelled'
            ]

            for (let i = 0; i < aedIconColors.length; i++) {
                this.icons[`aed-icon-${aedIconColors[i]}`] = `
                <svg class="aed-icon-${aedIconColors[i]}" width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                   <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="currentColor"/>
                   <path fill-rule="evenodd" clip-rule="evenodd" d="M4.24427 12.1847C3.52008 8.66747 5.92469 6.00935 8.62324 5.9847C10.0101 5.96353 11.745 6.69329 12.6696 8.45616C13.5943 6.69329 15.3291 5.96353 16.7161 5.9847C19.4146 6.00935 21.8192 8.66747 21.095 12.1847C20.543 14.8659 17.6742 18.3526 12.6696 21.7323C7.66508 18.3526 4.79632 14.8659 4.24427 12.1847ZM9.74907 16.6282L10.6676 6.95791C11.2992 7.32044 11.8819 7.87383 12.2909 8.65357L12.508 9.06762L11.4718 13.8718L15.3824 11.0546L13.6597 18.8116H14.6734L12.6449 21.0557L11.4354 18.2502L12.4492 18.6045L13.0116 14.2869L9.74907 16.6282Z" fill="white"/>
               </svg>`
            }

            // Generated icons for incident status
            const incidentIconColors = [
                'Created',
                'InProgress',
                'Completed',
                'Canceled'
            ]

            for (let i = 0; i < incidentIconColors.length; i++) {
                this.icons[`incident-icon-${incidentIconColors[i]}`] = `
                <svg class="incident-icon-${incidentIconColors[i]}" width="25" height="40" viewBox="0 0 25 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                   <path d="M11.0075 0.0700632C9.62925 0.227349 7.94368 0.725421 6.67073 1.3633C4.57256 2.42062 2.55339 4.40417 1.40334 6.53627C-0.0188515 9.17519 -0.396348 12.5743 0.437655 15.388C0.938057 17.0832 2.23735 19.4949 4.66912 23.2086C7.28526 27.2282 8.03147 28.4777 9.24297 30.9069C10.5949 33.6157 11.4202 35.8003 12.1488 38.6401C12.3595 39.4528 12.5526 40.0645 12.5702 39.9946C12.5965 39.9247 12.7194 39.4091 12.8511 38.8586C13.3954 36.4993 14.5191 33.441 15.7219 31.038C16.9597 28.5826 17.9781 26.8786 20.5854 22.9115C21.9637 20.8056 22.3324 20.1852 23.3069 18.2716C24.5184 15.8948 24.8783 14.7239 24.9837 12.784C25.2207 8.31885 22.8592 3.99348 18.9525 1.72157C16.6612 0.393374 13.7027 -0.218295 11.0075 0.0700632Z" fill="white"/>
                   <path d="M11.083 0.6961C9.7745 0.844717 8.17429 1.31534 6.96579 1.91806C4.97385 2.9171 3.05692 4.79132 1.9651 6.80591C0.614915 9.29937 0.256533 12.5111 1.04831 15.1697C1.52337 16.7715 2.75688 19.0503 5.06553 22.5593C7.5492 26.3573 8.25763 27.538 9.40779 29.8333C10.6913 32.3928 11.4747 34.4569 12.1665 37.1403C12.3665 37.9081 12.5499 38.4861 12.5666 38.42C12.5916 38.354 12.7082 37.8668 12.8333 37.3467C13.35 35.1174 14.4168 32.2277 15.5586 29.9571C16.7338 27.637 17.7006 26.027 20.1759 22.2786C21.4844 20.2888 21.8345 19.7026 22.7596 17.8944C23.9098 15.6486 24.2515 14.5422 24.3515 12.7093C24.5765 8.49023 22.3346 4.40327 18.6257 2.25658C16.4504 1.00159 13.6417 0.423636 11.083 0.6961Z" fill="currentColor"/>
                   <path d="M10.8125 11.9829V22.1562C10.8125 22.38 10.9014 22.5946 11.0596 22.7529C11.2179 22.9111 11.4325 23 11.6562 23C11.88 23 12.0946 22.9111 12.2529 22.7529C12.4111 22.5946 12.5 22.38 12.5 22.1562V16.8125C12.5 16.6633 12.5593 16.5202 12.6648 16.4148C12.7702 16.3093 12.9133 16.25 13.0625 16.25C13.2117 16.25 13.3548 16.3093 13.4602 16.4148C13.5657 16.5202 13.625 16.6633 13.625 16.8125V22.1562C13.625 22.38 13.7139 22.5946 13.8721 22.7529C14.0304 22.9111 14.245 23 14.4688 23C14.6925 23 14.9071 22.9111 15.0654 22.7529C15.2236 22.5946 15.3125 22.38 15.3125 22.1562V12.5938C15.3125 12.5192 15.3421 12.4476 15.3949 12.3949C15.4476 12.3421 15.5192 12.3125 15.5938 12.3125C15.6683 12.3125 15.7399 12.3421 15.7926 12.3949C15.8454 12.4476 15.875 12.5192 15.875 12.5938V15.4062C15.875 15.63 15.9639 15.8446 16.1221 16.0029C16.2804 16.1611 16.495 16.25 16.7188 16.25C16.9425 16.25 17.1571 16.1611 17.3154 16.0029C17.4736 15.8446 17.5625 15.63 17.5625 15.4062V12.3125C17.5625 11.4174 17.2069 10.5589 16.574 9.92601C15.9411 9.29308 15.0826 8.9375 14.1875 8.9375H11.078C10.9034 8.93731 10.7312 8.89649 10.5751 8.81825L10.2039 8.63263C10.049 8.55522 9.91864 8.43627 9.82745 8.28905C9.73626 8.14184 9.68781 7.97217 9.6875 7.799V5.84375C9.6875 5.61997 9.59861 5.40536 9.44037 5.24713C9.28214 5.08889 9.06753 5 8.84375 5C8.61997 5 8.40536 5.08889 8.24713 5.24713C8.08889 5.40536 8 5.61997 8 5.84375V8.18712C8 8.9915 8.4545 9.72837 9.1745 10.0872L10.25 10.625C10.61 10.985 10.8125 11.4732 10.8125 11.9829Z" fill="white"/>
                   <path d="M13.0625 8.375C13.5101 8.375 13.9393 8.19721 14.2557 7.88074C14.5722 7.56428 14.75 7.13505 14.75 6.6875C14.75 6.23995 14.5722 5.81072 14.2557 5.49426C13.9393 5.17779 13.5101 5 13.0625 5C12.6149 5 12.1857 5.17779 11.8693 5.49426C11.5528 5.81072 11.375 6.23995 11.375 6.6875C11.375 7.13505 11.5528 7.56428 11.8693 7.88074C12.1857 8.19721 12.6149 8.375 13.0625 8.375Z" fill="white"/>
                </svg>`
            }
        }
    },
    mounted() {
        // Initialize icon markers
        this.initializeIcons()
        
        // Load map and markers using Leaflet
        this.loadLeaflet()
        
        // On event js "location-changed" refresh markers
        window.addEventListener('location-changed', (e) => {
            this.onLocationChanged(e.detail.lat, e.detail.lon, e.detail.id, e.detail.icon, e.detail.initialZoom)
        })
    }
}
</script>

<template>
    <div id="map" style="height: 500px; z-index: 1"></div>
</template>

<style scoped>
    @import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.css";
</style>
